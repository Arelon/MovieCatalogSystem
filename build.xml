<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="MCS" basedir="." default="zip" xmlns:ivy="antlib:org.apache.ivy.ant">

    <property name="ivy.install.version" value="2.2.0"/>
    <property name="ivy.jar.dir" value="${basedir}/ivy"/>
    <property name="ivy.jar.file" value="${ivy.jar.dir}/ivy.jar"/>

    <condition property="ivy.home" value="${env.IVY_HOME}">
        <isset property="env.IVY_HOME"/>
    </condition>
    <property name="ivy.home" value="${user.home}/.ant"/>

    <property name="src.version" value="0.5"/>
    <property name="build.version" value="203"/>

    <property name="root.dir" value="."/>
    <property name="src.dir" value="src"/>
    <property name="ivy.resolved.libs.target.dir" value="build/lib"/>
    <property name="explicit.lib.dir" value="lib"/>
    <property name="restore.dir" value="build/restore"/>
    <property name="export.dir" value="startup/export"/>
    <property name="restore.dir" value="startup/restore"/>
    <property name="startup.dir" value="startup"/>

    <property name="compile.dir" value="build/compile"/>
    <property name="distro.dir" value="build/distro"/>
    <property name="zip.target.dir" value="build"/>

    <target name="download-ivy" unless="offline">
        <mkdir dir="${ivy.jar.dir}"/>
        <get src="http://repo2.maven.org/maven2/org/apache/ivy/ivy/${ivy.install.version}/ivy-${ivy.install.version}.jar"
             dest="${ivy.jar.file}" usetimestamp="true"/>
    </target>

    <target name="init-ivy" depends="download-ivy">
        <path id="ivy.lib.path">
            <fileset dir="${ivy.jar.dir}" includes="*.jar"/>
        </path>
        <taskdef resource="org/apache/ivy/ant/antlib.xml"
                 uri="antlib:org.apache.ivy.ant" classpathref="ivy.lib.path"/>
    </target>

    <target name="resolve" description="Retrieve dependencies with ivy" depends="init-ivy">
        <ivy:retrieve file="ivy.xml" pattern="${ivy.resolved.libs.target.dir}/[artifact].[ext]" />
        <copy todir="${ivy.resolved.libs.target.dir}" overwrite="true">
            <fileset dir="${explicit.lib.dir}">
                <include name="**/*.jar"/>
            </fileset>
        </copy>
    </target>

    <path id="classpath">
        <fileset dir="${ivy.resolved.libs.target.dir}">
            <include name="*.*"/>
        </fileset>
    </path>

    <target name="init" description="Init tasks" depends="resolve">
        <delete dir="${compile.dir}" failonerror="false"/>
        <delete dir="${distro.dir}" failonerror="false"/>
        <tstamp/>
    </target>

    <target name="compile" description="Copying compiled MCS files" depends="init">
        <mkdir dir="${compile.dir}"/>

        <javac srcdir="${src.dir}" classpathref="classpath" target="1.6" destdir="${compile.dir}" encoding="UTF-8">
        </javac>

        <copy todir="${compile.dir}" overwrite="true">
            <fileset dir="${src.dir}">
                <exclude name="**/*.java"/>
            </fileset>
        </copy>
    </target>

    <target name="jar" description="JARs the MovieCatalogSystem" depends="compile">
        <mkdir dir="${distro.dir}"/>

        <jar destfile="${distro.dir}/mcs.jar">
            <manifest>
                <attribute name="Manifest-Version" value="1.0"/>
                <attribute name="Main-Class" value="net.milanaleksic.mcs.Startup"/>
                <attribute name="Implementation-Version" value="${src.version}.${build.version}"/>
            </manifest>
            <fileset dir="${compile.dir}"/>
        </jar>

        <copy todir="${ivy.resolved.libs.target.dir}" file="${distro.dir}/mcs.jar" overwrite="true"/>
    </target>

    <target name="zip" description="ZIPs the whole distro" depends="jar">
        <mkdir dir="${distro.dir}"/>

        <delete>
            <fileset dir="">
                <include name="${ant.project.name}-${src.version}.${build.version}-${DSTAMP}*.zip"/>
            </fileset>
        </delete>

        <copy todir="${distro.dir}" overwrite="true">
            <fileset dir="${startup.dir}" excludes="*reveng*,*dev*">
                <include name="*.properties"/>
                <include name=".launcher"/>
                <include name="*.xml"/>
                <include name="*.jpg"/>
            </fileset>
        </copy>

        <delete file="${ant.project.name}-${src.version}.${build.version}-*.zip" failonerror="false"/>

        <zip destfile="${zip.target.dir}/${ant.project.name}-${src.version}.${build.version}-${DSTAMP}${TSTAMP}.zip">
            <zipfileset dir="${ivy.resolved.libs.target.dir}" prefix="lib" excludes="mcs.jar"/>
            <zipfileset dir="${distro.dir}" prefix="bin" excludes="*.jar"/>
            <zipfileset dir="${distro.dir}" prefix="lib" includes="*.jar"/>
            <zipfileset dir="${root.dir}" prefix="" includes="*.exe"/>
            <zipfileset dir="${export.dir}" prefix="bin/export"/>
        </zip>

        <delete dir="${compile.dir}" failonerror="false"/>
        <delete dir="${distro.dir}" failonerror="false"/>
        <delete dir="${ivy.resolved.libs.target.dir}" failonerror="false"/>
    </target>


</project>